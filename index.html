<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ãƒ¢ãƒ–ç”Ÿå¾’DB</title>
  <style>
    body { font-family: sans-serif; margin: 1rem; }
    .filter { margin-bottom: 1rem; }
    .grid { display: flex; flex-wrap: wrap; gap: 1rem; }
    .card { width: 200px; border: 1px solid #ccc; padding: .5rem; text-align: center; transition: background 0.5s ease; }
    .card.highlight { background: yellow; }
    .card img { width: 100%; height: auto; }
    .card a { word-break: break-all; font-size: 0.8em; display: block; margin-top: 0.5em; }
  </style>
</head>
<body>
  <h1>ãƒ¢ãƒ–ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h1>
  <div class="filter">
    é«ªè‰²ï¼š<select id="hairFilter"><option value="">-- å…¨ã¦ --</option></select>
    é«ªå‹1ï¼š<select id="styleFilter"><option value="">-- å…¨ã¦ --</option></select>
    å­¦å¹´ï¼š<select id="gradeFilter"><option value="">-- å…¨ã¦ --</option></select>
    çœ¼é¡ï¼š<input type="checkbox" id="glassesFilter"><label for="glassesFilter">ã‚ã‚Šã®ã¿</label>
  </div>

  <div class="grid" id="result"></div>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQzzaAtY9PHkoLNhL1Stf6fszs22WzAvG7tQrrAmmkztOvXkodTSenhWcER1kcLS5G_eV8uVAV-zk84/pub?gid=0&single=true&output=tsv';
    let mobData = [];

    async function loadData() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const rows = text.trim().split('\n').map(r => r.split('\t'));
      const headers = rows.shift();
      mobData = rows.map(cols => {
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = cols[i]?.trim());
        return obj;
      }).filter(d => d['ID']);

      populateFilters();
      applyFilter();

      const target = location.hash?.slice(1);
      if (target) {
        setTimeout(() => highlightCard(target), 300);
      }
    }

    function highlightCard(id) {
      const el = document.getElementById(id);
      if (el) {
        el.classList.add('highlight');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => el.classList.remove('highlight'), 2000);
      }
    }

    window.addEventListener('hashchange', () => {
      const target = location.hash.slice(1);
      highlightCard(target);
    });

    function populateFilters() {
      const hairSet = new Set(), gradeSet = new Set(), styleSet = new Set();
      mobData.forEach(d => {
        d['é«ªè‰²']?.split(',').forEach(h => hairSet.add(h.trim()));
        d['é«ªå‹ï¼‘']?.split(',').forEach(s => styleSet.add(s.trim()));
        if(d['å­¦å¹´']) gradeSet.add(d['å­¦å¹´']);
      });
      hairSet.forEach(h => addOption('hairFilter', h));
      gradeSet.forEach(g => addOption('gradeFilter', g));
      styleSet.forEach(s => addOption('styleFilter', s));

      ['hairFilter','gradeFilter','styleFilter'].forEach(id =>
        document.getElementById(id).addEventListener('change', applyFilter)
      );
      document.getElementById('glassesFilter').addEventListener('change', applyFilter);
    }

    function addOption(selId, val) {
      const sel = document.getElementById(selId);
      sel.insertAdjacentHTML('beforeend', `<option value="${val}">${val}</option>`);
    }

    function applyFilter() {
      const hf = document.getElementById('hairFilter').value;
      const gf = document.getElementById('gradeFilter').value;
      const sf = document.getElementById('styleFilter').value;
      const gl = document.getElementById('glassesFilter').checked;

      const filtered = mobData.filter(d => {
        const hairMatch = !hf || (d['é«ªè‰²'] && d['é«ªè‰²'].split(',').map(s => s.trim()).includes(hf));
        const styleMatch = !sf || (d['é«ªå‹ï¼‘'] && d['é«ªå‹ï¼‘'].split(',').map(s => s.trim()).includes(sf));
        const gradeMatch = !gf || d['å­¦å¹´'] === gf;
        const glassesMatch = !gl || d['çœ¼é¡'] === 'æœ‰';
        return hairMatch && gradeMatch && styleMatch && glassesMatch;
      });

      render(filtered);
    }

    function ensureJpg(url) {
      if (!url) return '';
      let base = url.replace(/\/$/, '');
      const imgurMatch = base.match(/^https?:\/\/imgur\.com\/([a-zA-Z0-9]+)/);
      if (imgurMatch) {
        return `https://i.imgur.com/${imgurMatch[1]}.jpg`;
      }
      if (base.includes('i.imgur.com') && !base.match(/\.(jpg|png|gif|jpeg)$/)) {
        return base + '.jpg';
      }
      return base;
    }

    function render(arr) {
      const container = document.getElementById('result');
      container.innerHTML = '';
      arr.forEach(d => {
        const imageUrl = ensureJpg(d['ç”»åƒ']);
        const card = document.createElement('div');
        card.className = 'card';
        card.id = d['ID'];

        const nameText = d['åå‰'] ? `${d['åå‰']} (${d['ID']})` : d['ID'];
        const sameMobLink = d['åŒä¸€ãƒ¢ãƒ–'] ? `<div><a href="#${d['åŒä¸€ãƒ¢ãƒ–']}">åŒä¸€ãƒ¢ãƒ–: ${d['åŒä¸€ãƒ¢ãƒ–']}</a></div>` : '';
        const hairStyle2 = d['é«ªå‹ï¼’'] ? `<div>é«ªå‹2: ${d['é«ªå‹ï¼’']}</div>` : '';
        const remark = d['å‚™è€ƒ'] ? `<div>å‚™è€ƒ: ${d['å‚™è€ƒ']}</div>` : '';

        card.innerHTML = `
          <img src="${imageUrl}" alt="${nameText}">
          <div><strong>${nameText}</strong></div>
          <div>é«ªè‰²: ${d['é«ªè‰²']}</div>
          <div>å­¦å¹´: ${d['å­¦å¹´']}</div>
          <div>é«ªå‹1: ${d['é«ªå‹ï¼‘']}</div>
          ${hairStyle2}
          <div>${d['çœ¼é¡'] === 'æœ‰' ? 'ğŸ‘“ çœ¼é¡ã‚ã‚Š' : ''}</div>
          ${remark}
          ${sameMobLink}
          <a href="${d['ãƒªãƒ³ã‚¯']}" target="_blank">ãƒªãƒ³ã‚¯</a>
        `;
        container.appendChild(card);
      });
    }

    loadData();
  </script>
</body>
</html>
